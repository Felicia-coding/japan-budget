<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠå¿«é€Ÿè¨˜å¸³ (æ—¥å¹£ç¾é‡‘/å¡åˆ·åˆ†æµç‰ˆ)</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            color: #d32f2f; 
            text-align: center;
            margin-bottom: 30px;
        }

        /* è¼¸å…¥å€å¡Šæ¨£å¼ */
        #input-area {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* è¼¸å…¥å€å¡Šåˆ†çµ„æ¨™é¡Œ */
        h3 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #444;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ddd;
        }
        
        h3:first-child {
            margin-top: 0;
        }

        /* è¼¸å…¥æ¡†å’Œé¸å–®æ¨£å¼ */
        input[type="text"], select {
            width: calc(100% - 22px);
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1.2em;
            box-sizing: border-box; 
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button:not(#export-btn, .delete-btn) {
            width: 100%;
            padding: 15px;
            background-color: #4CAF50; 
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        button:hover:not(#export-btn, .delete-btn) {
            background-color: #45a049;
        }
        
        /* å€å¡Šåˆ†éš”ç·š */
        hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #eee;
        }

        /* ç¸½é‡‘é¡é¡¯ç¤ºå€ (æ¢å¾©åŸå§‹ç°¡æ½”æ¨£å¼) */
        #summary-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ffd400; /* é»ƒè‰² */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* ä¿®æ­£: ç¸½é¡å­—é«”å¤§å°ä¸€è‡´ */
        #total-jpy {
            font-size: 2.0em; 
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 15px; /* èˆ‡ TWD åˆ†éš” */
            display: block;
        }
        
        #total-twd {
            font-size: 2.0em; 
            font-weight: bold;
            color: #008080; 
            display: block;
        }
        
        /* èª¿æ•´èªªæ˜æ–‡å­—çš„å­—é«”å¤§å° */
        #summary-area p {
            font-size: 1.1em; 
            margin: 5px 0 0 !important;
            color: #555;
            display: block;
        }
        
        /* æ­·å²è¨˜éŒ„å€å¡Šæ¨™é¡Œ */
        #history-header {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 10px;
        }

        /* åˆ—è¡¨åˆ†çµ„æ¨™é¡Œ */
        .expense-list-section h4 {
            margin-top: 25px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            color: #333;
        }

        /* æ—¥å¹£å¡åˆ·æ¸…å–®ä¸­ TWD çš„æ¨£å¼ */
        .twd-in-list {
            font-size: 0.9em;
            color: #008080;
            margin-left: 8px;
            font-style: italic;
        }

        /* æ—¥æœŸåˆ†çµ„æ¨™é¡Œæ¨£å¼ */
        .date-group {
            margin-top: 20px;
            margin-bottom: 10px;
            padding: 8px 10px;
            font-weight: bold;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* æ—¥å¹£ç¾é‡‘æ—¥æœŸåˆ†çµ„ */
        #jpy-cash-list-container .date-group {
            background-color: #fbe4e4; 
            color: #d32f2f; 
        }
        
        /* æ—¥å¹£å¡åˆ·æ—¥æœŸåˆ†çµ„ */
        #jpy-card-list-container .date-group {
            background-color: #fff3e0; 
            color: #ff9800; 
        }
        
        /* å¡åˆ¥åŠ ç¸½å€å¡Šçš„æ¨£å¼ */
        .card-summary-block {
            padding: 5px 10px; 
            background: #f0f8ff; 
            border-radius: 4px; 
            margin-bottom: 5px;
        }
        
        /* æ¸…å–®é€šç”¨æ¨£å¼ */
        .expense-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .expense-list li {
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        
        .item-description {
            flex-grow: 1;
            padding-right: 10px;
            color: #555;
        }
        
        .card-name-in-list {
            font-size: 0.8em; 
            color: #888;
            margin-left: 8px; 
            font-style: italic;
        }
        
        .item-amount {
            font-weight: bold;
            white-space: nowrap; 
            color: #d32f2f; /* JPY é è¨­é¡è‰² */
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1em;
            padding: 0 5px;
            margin-left: 10px;
            transition: color 0.2s;
            width: auto; 
        }
        
        .delete-btn:hover {
            color: #d32f2f;
        }
        
        /* æ¸…é™¤æŒ‰éˆ• */
        #clear-btn {
            margin-top: 20px;
            background-color: #9e9e9e; 
        }
        #clear-btn:hover {
            background-color: #757575;
        }
    </style>
</head>
<body>

    <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠå¿«é€Ÿè¨˜å¸³ ğŸ’¸</h1>

    <div id="summary-area">
        <p>æ—¥å¹£ç¸½æ”¯å‡ºåˆè¨ˆ</p>
        <div id="total-jpy">Â¥ 0</div>
        <p>å°å¹£ç¸½æ”¯å‡ºåˆè¨ˆ</p>
        <div id="total-twd">NT$ 0</div>
    </div>

    <div id="input-area">
        
        <h3>ğŸ’µ æ—¥å¹£ç¾é‡‘æ”¯å‡º (åƒ…å¡« JPY)</h3>
        <input type="text" id="jpy-cash-input" placeholder="æ—¥å¹£é‡‘é¡: 1500 äº¤é€šè²»" autofocus>
        <button onclick="addExpense('CASH_JPY')">+ è¨˜éŒ„æ—¥å¹£ç¾é‡‘</button>

        <hr>

        <h3>ğŸ’³ æ—¥å¹£å¡åˆ·æ”¯å‡º (JPY/NT$)</h3>
        <input type="text" id="jpy-card-input" placeholder="æ—¥å¹£åˆ·å¡é‡‘é¡: 5000 è—¥å¦ (è¨˜å¸³ç”¨)">
        <input type="text" id="twd-card-input" placeholder="å°å¹£å…¥å¸³/å¯¦éš›æ”¯å‡ºé‡‘é¡: 1080">
        
        <select id="twd-card-select-jpy">
            <option value="">-- è«‹é¸æ“‡å¡åˆ¥ / ä»˜æ¬¾æ–¹å¼ --</option>
            </select>
        <button onclick="addExpense('CARD_JPY')">+ è¨˜éŒ„æ—¥å¹£å¡åˆ·/å°å¹£æ”¯å‡º</button>
    </div>

    <div id="history-area">
        <div id="history-header">
            <h2>ğŸ§¾ æ”¯å‡ºæ­·å²è¨˜éŒ„</h2>
            <button id="export-btn" onclick="exportToCsv()">åŒ¯å‡º Excel</button>
        </div>
        
        <div id="jpy-cash-list-container" class="expense-list-section"></div>
        
        <div id="jpy-card-list-container" class="expense-list-section"></div>

        <button id="clear-btn" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
    </div>

    <script>
        const STORAGE_KEY = 'japan_trip'; 
        
        // 1. DOM å…ƒç´  - è¼¸å…¥
        const jpyCashInput = document.getElementById('jpy-cash-input');
        const jpyCardInput = document.getElementById('jpy-card-input');
        const twdCardInput = document.getElementById('twd-card-input');
        const twdCardSelectJPY = document.getElementById('twd-card-select-jpy');
        
        // 2. DOM å…ƒç´  - é¡¯ç¤º (æ²¿ç”¨åŸæœ¬çš„ ID)
        const totalJpyDisplay = document.getElementById('total-jpy'); 
        const totalTwdDisplay = document.getElementById('total-twd'); 
        
        const jpyCashListContainer = document.getElementById('jpy-cash-list-container');
        const jpyCardListContainer = document.getElementById('jpy-card-list-container');
        
        let expenses = [];

        // å¡åˆ¥é¸é …å®šç¾© (é›†ä¸­ç®¡ç†)
        const cardOptions = [
            { value: "è¯é‚¦å‰é¶´å¡", text: "è¯é‚¦å‰é¶´å¡ (ApplePay)" },
            { value: "æ°¸è±å¹£å€å¡", text: "æ°¸è±å¹£å€å¡ (ApplePay)" },
            { value: "ç‰å±±ç†Šæœ¬ç†Šå¡", text: "ç‰å±±ç†Šæœ¬ç†Šå¡ (paypay)" },
            { value: "åœ‹æ³°CUBEå¡", text: "åœ‹æ³°CUBEå¡ (ApplePay)" },
            { value: "å…¶ä»–", text: "å…¶ä»–" },
            { value: "ç¾é‡‘ (å°å¹£)", text: "ç¾é‡‘ (å°å¹£)" }, // ç”¨æ–¼è¨˜éŒ„ç´”å°å¹£æ¶ˆè²»
        ];
        
        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆå§‹åŒ–å¡åˆ¥é¸å–® ---
        function initCardSelects() {
            const defaultOption = '<option value="">-- è«‹é¸æ“‡å¡åˆ¥ / ä»˜æ¬¾æ–¹å¼ --</option>';
            const optionsHtml = cardOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
            
            twdCardSelectJPY.innerHTML = defaultOption + optionsHtml;
        }

        // --- å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ / è§£æè¼¸å…¥ ---
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function getTodayDateString() {
            return formatDate(new Date());
        }

        function parseExpenseInput(inputText, currency) {
            const match = inputText.match(/^(\d+[\d\.]*)\s*(.*)/);
            let amount = 0;
            let description = '';

            if (match) {
                amount = parseFloat(match[1]);
                description = match[2] || `${currency}æ”¯å‡º`;
            }

            if (isNaN(amount) || amount < 0) {
                return { error: `è«‹è¼¸å…¥æœ‰æ•ˆçš„${currency}é‡‘é¡ï¼` };
            }
            
            return { amount, description: description.trim() };
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢æ”¯å‡º (å…©ç¨®æ¨¡å¼) ---
        function addExpense(type) {
            let amountJPY = 0;
            let amountTWD = 0;
            let description = '';
            let cardUsed = ''; 
            let success = false;

            if (type === 'CASH_JPY') {
                // æ¨¡å¼ 1: æ—¥å¹£ç¾é‡‘ (åƒ… JPY)
                const inputText = jpyCashInput.value.trim();
                if (!inputText) return alert('è«‹è¼¸å…¥æ—¥å¹£ç¾é‡‘é‡‘é¡ï¼');
                
                const result = parseExpenseInput(inputText, 'æ—¥å¹£ç¾é‡‘');
                if (result.error) return alert(result.error);
                
                amountJPY = result.amount;
                description = result.description;
                cardUsed = 'æ—¥å¹£ç¾é‡‘'; // æ¨™è¨˜ç‚ºç¾é‡‘
                success = true;
                jpyCashInput.value = '';
                
            } else if (type === 'CARD_JPY') {
                // æ¨¡å¼ 2: æ—¥å¹£å¡åˆ·/æ‰€æœ‰å°å¹£ (JPY, TWD, å¡åˆ¥ å¿…å¡«)
                const jpyText = jpyCardInput.value.trim();
                const twdText = twdCardInput.value.trim();
                cardUsed = twdCardSelectJPY.value;

                if (!jpyText || !twdText || !cardUsed) {
                    return alert('æ—¥å¹£å¡åˆ·æ”¯å‡ºï¼šæ—¥å¹£é‡‘é¡ã€å°å¹£é‡‘é¡ã€å¡åˆ¥éƒ½å¿…é ˆå¡«å¯«ï¼');
                }

                const jpyResult = parseExpenseInput(jpyText, 'æ—¥å¹£åˆ·å¡');
                const twdResult = parseExpenseInput(twdText, 'å°å¹£å…¥å¸³');

                if (jpyResult.error || twdResult.error) {
                    return alert(jpyResult.error || twdResult.error);
                }

                amountJPY = jpyResult.amount;
                amountTWD = twdResult.amount;
                // ç”±æ–¼æ˜¯å¡åˆ·ï¼Œæè¿°ä»¥ JPY æ¬„ä½ç‚ºä¸»
                description = jpyResult.description; 
                success = true;

                jpyCardInput.value = '';
                twdCardInput.value = '';
                twdCardSelectJPY.value = '';
            }

            if (success) {
                const newExpense = {
                    id: Date.now(),
                    jpy_amount: amountJPY,
                    twd_amount: amountTWD,
                    description: description, 
                    date: getTodayDateString(),
                    card_used: cardUsed,
                    type: type 
                };
                expenses.unshift(newExpense);
                saveAndRefresh();
                jpyCashInput.focus(); 
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆªé™¤å–®ç­†æ”¯å‡º / æ¸…ç©ºæ‰€æœ‰æ•¸æ“š (ä¿æŒä¸è®Š) ---
        function deleteExpense(id) {
            expenses = expenses.filter(expense => expense.id !== id);
            saveAndRefresh();
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜å¸³è¨˜éŒ„å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                expenses = [];
                saveAndRefresh();
            }
        }
        
        // --- è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—ç¸½é¡ (æ ¸å¿ƒä¿®æ”¹é») ---
        function calculateTotal() {
            // 1. æ—¥å¹£ç¸½æ”¯å‡ºåˆè¨ˆ (æ‰€æœ‰ JPY é‡‘é¡ç›¸åŠ )
            const totalJpy = expenses.reduce((sum, expense) => sum + expense.jpy_amount, 0);
            
            // 2. å°å¹£ç¸½æ”¯å‡ºåˆè¨ˆ (æ‰€æœ‰ TWD é‡‘é¡ç›¸åŠ )
            const totalTwd = expenses.reduce((sum, expense) => sum + expense.twd_amount, 0);

            // æ ¼å¼åŒ–ä¸¦æ›´æ–°é¡¯ç¤º
            totalJpyDisplay.textContent = 'Â¥ ' + totalJpy.toLocaleString('ja-JP', { maximumFractionDigits: 0 });
            totalTwdDisplay.textContent = 'NT$ ' + totalTwd.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        // --- è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å°å¹£å¡åˆ¥ç¸½è¨ˆ ---
        function calculateTwdCardTotals() {
            // åªè¨ˆç®— CARD_JPY æ¨¡å¼çš„ TWD ç¸½é¡
            const twdExpenses = expenses.filter(e => e.type === 'CARD_JPY' && e.twd_amount > 0);
            return twdExpenses.reduce((totals, expense) => {
                const card = expense.card_used || 'æœªçŸ¥å¡åˆ¥';
                if (!totals[card]) {
                    totals[card] = 0;
                }
                totals[card] += expense.twd_amount || 0;
                return totals;
            }, {});
        }


        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåŒ¯å‡ºæ•¸æ“šç‚º CSV æ ¼å¼ (æ²¿ç”¨ä¸Šä¸€å€‹ç­”æ¡ˆçš„æ˜ç´°æ¨¡å¼) ---
        function exportToCsv() {
             if (expenses.length === 0) {
                alert('æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            
            // 1. åŒ¯å‡ºæ”¯å‡ºè¨˜éŒ„æ¸…å–® (æ˜ç´°)
            csvContent += "æ—¥æœŸ,èªªæ˜,é¡å‹,æ—¥å¹£é‡‘é¡(Â¥),å°å¹£é‡‘é¡(NT$),ä»˜æ¬¾å¡åˆ¥\n"; 

            expenses.forEach(expense => {
                const descriptionSafe = expense.description.replace(/,/g, ';'); 
                const jpy = expense.jpy_amount.toFixed(0); 
                const twd = expense.twd_amount.toFixed(0); 
                const card = expense.card_used || ''; 
                
                let typeName = (expense.type === 'CASH_JPY') ? 'æ—¥å¹£ç¾é‡‘' : 'æ—¥å¹£å¡åˆ·';
                
                csvContent += `${expense.date},${descriptionSafe},${typeName},${jpy},${twd},${card}\n`; 
            });

            // 2. æ–°å¢å¡åˆ¥ç¸½è¨ˆå€å¡Š (TWD)
            const cardTotals = calculateTwdCardTotals();
            const totalTwdForCard = expenses.filter(e => e.type === 'CARD_JPY').reduce((sum, expense) => sum + expense.twd_amount, 0);

            csvContent += "\n\n"; 
            csvContent += "å°å¹£å¡åˆ¥ç¸½çµ (NT$)\n"; 

            csvContent += "å¡åˆ¥,ç¸½é‡‘é¡(NT$)\n";
            
            Object.keys(cardTotals).sort().forEach(card => {
                const cardAmount = cardTotals[card].toFixed(0);
                csvContent += `${card},${cardAmount}\n`;
            });

            csvContent += `ç¸½è¨ˆ(TWD),${totalTwdForCard.toFixed(0)}\n`;


            // 3. åŸ·è¡Œä¸‹è¼‰
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            const filename = `japan_budget_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`;
            link.setAttribute("download", filename);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- ç•«é¢æ›´æ–°ï¼šæ¸²æŸ“åˆ—è¡¨ (æ²¿ç”¨ä¸Šä¸€å€‹ç­”æ¡ˆçš„æ¸…å–®åˆ†çµ„é‚è¼¯) ---
        function renderExpenses() {
            jpyCashListContainer.innerHTML = '';
            jpyCardListContainer.innerHTML = '';

            if (expenses.length === 0) {
                jpyCashListContainer.innerHTML = '<h4>ğŸ’µ æ—¥å¹£ç¾é‡‘æ”¯å‡º (Â¥)</h4><p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</p>';
                jpyCardListContainer.innerHTML = '<h4>ğŸ’³ æ—¥å¹£å¡åˆ·æ”¯å‡º (Â¥/NT$)</h4><p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</p>';
                return;
            }

            // 1. éæ¿¾æ”¯å‡ºåˆ—è¡¨
            const jpyCashList = expenses.filter(e => e.type === 'CASH_JPY');
            const jpyCardList = expenses.filter(e => e.type === 'CARD_JPY');
            
            // 2. æ¸²æŸ“ JPY ç¾é‡‘
            jpyCashListContainer.innerHTML += `<h4>ğŸ’µ æ—¥å¹£ç¾é‡‘æ”¯å‡º (Â¥)</h4>`;
            renderList(jpyCashListContainer, jpyCashList, 'CASH_JPY');

            // 3. æ¸²æŸ“ JPY å¡åˆ·/æ‰€æœ‰å°å¹£
            jpyCardListContainer.innerHTML += `<h4>ğŸ’³ æ—¥å¹£å¡åˆ·æ”¯å‡º (Â¥/NT$)</h4>`;
            renderList(jpyCardListContainer, jpyCardList, 'CARD_JPY');
            

            // --- è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“å–®ä¸€åˆ†çµ„åˆ—è¡¨ ---
            function renderList(container, list, listType) {
                if (list.length === 0) {
                    container.innerHTML += '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</p>';
                    return;
                }
                
                const currencyLocale = 'ja-JP'; 
                const amountKey = 'jpy_amount'; 

                const groupedExpenses = list.reduce((groups, expense) => {
                    const date = expense.date;
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(expense);
                    return groups;
                }, {});

                const sortedDates = Object.keys(groupedExpenses).sort().reverse();
                let htmlContent = '';

                sortedDates.forEach(date => {
                    const dailyExpenses = groupedExpenses[date];

                    // **[ç•¶æ—¥ç¸½æ”¯å‡ºè¨ˆç®—]** (Primary å¹£åˆ¥ - JPY)
                    const dailyTotal = dailyExpenses.reduce((sum, expense) => sum + expense[amountKey], 0);
                    const dailyTotalFormatted = dailyTotal.toLocaleString(currencyLocale, { maximumFractionDigits: 0 });

                    // æ—¥æœŸåˆ†çµ„æ¨™é¡Œ
                    htmlContent += `
                        <div class="date-group">
                            <span>${date}</span> 
                            <span>åˆè¨ˆ: Â¥ ${dailyTotalFormatted}</span>
                        </div>
                    `;
                    
                    // **[å¡åˆ¥ç¸½è¨ˆå€ (åƒ…é™ CARD_JPY çš„ TWD)]**
                    if (listType === 'CARD_JPY') {
                        const cardTotals = dailyExpenses.reduce((totals, expense) => {
                            const card = expense.card_used || 'æœªçŸ¥å¡åˆ¥';
                            const twdAmount = expense.twd_amount || 0;
                            if (!totals[card]) totals[card] = 0;
                            totals[card] += twdAmount; 
                            return totals;
                        }, {});

                        htmlContent += '<div class="card-summary-block">';
                        
                        Object.keys(cardTotals).sort().forEach(card => {
                            const cardAmountFormatted = cardTotals[card].toLocaleString('zh-TW', { maximumFractionDigits: 0 });
                            htmlContent += `
                                <div class="card-summary-item">
                                    <span>${card} TWD ç¸½è¨ˆ:</span>
                                    <span style="font-weight: bold; color: #008080;">NT$ ${cardAmountFormatted}</span>
                                </div>
                            `;
                        });
                        htmlContent += '</div>';
                    }

                    // å‰µå»ºæ”¯å‡ºåˆ—è¡¨
                    htmlContent += `<ul class="expense-list">`;

                    dailyExpenses.forEach(expense => {
                        const primaryAmount = expense[amountKey].toLocaleString(currencyLocale, { maximumFractionDigits: 0 });
                        
                        let descriptionHtml = expense.description;
                        let amountDisplay = `Â¥ ${primaryAmount}`;
                        
                        // è™•ç† CARD_JPY (è¦é¡¯ç¤º JPY/TWD/å¡åˆ¥)
                        if (listType === 'CARD_JPY') {
                            const secondaryAmount = expense.twd_amount.toLocaleString('zh-TW', { maximumFractionDigits: 0 });
                            descriptionHtml += ` <span class="twd-in-list"> (NT$ ${secondaryAmount})</span>`;
                            descriptionHtml += ` <span class="card-name-in-list">(${expense.card_used})</span>`;
                        }
                        // è™•ç† CASH_JPY
                        else if (listType === 'CASH_JPY') {
                            descriptionHtml += ` <span class="card-name-in-list">(ç¾é‡‘)</span>`;
                        }


                        htmlContent += `
                            <li>
                                <span class="item-description">${descriptionHtml}</span>
                                <span class="item-amount">${amountDisplay}</span>
                                <button class="delete-btn" onclick="deleteExpense(${expense.id})">x</button>
                            </li>
                        `;
                    });

                    htmlContent += `</ul>`;
                });
                
                container.innerHTML += htmlContent;
            }
        }
        
        // --- æ•¸æ“šè™•ç†ï¼šå„²å­˜å’Œåˆ·æ–° ---
        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            renderExpenses();
            calculateTotal();
        }
        
        // --- åˆå§‹åŒ– ---
        function init() {
            const storedExpenses = localStorage.getItem(STORAGE_KEY);
            if (storedExpenses) {
                let parsedExpenses = JSON.parse(storedExpenses);
                expenses = parsedExpenses.map(exp => {
                    // å…¼å®¹èˆŠè³‡æ–™ï¼šæ²’æœ‰ type æ¬„ä½æ™‚ï¼Œè‡ªå‹•åˆ¤æ–·
                    if (!exp.type) {
                         // èˆŠè³‡æ–™ä¿®æ­£é‚è¼¯ (èˆ‡ä¸Šä¸€å€‹ç­”æ¡ˆç›¸åŒï¼Œç¢ºä¿è³‡æ–™çµæ§‹æ­£ç¢º)
                         if (exp.twd_amount > 0) {
                            exp.type = 'CARD_JPY';
                         } else {
                            exp.type = 'CASH_JPY';
                         }
                    }
                    exp.card_used = exp.card_used || (exp.type === 'CASH_JPY' ? 'æ—¥å¹£ç¾é‡‘' : '');
                    return exp;
                });
            }
            
            initCardSelects();
            renderExpenses();
            calculateTotal();
            
            // ç¶å®š Enter éµäº‹ä»¶
            jpyCashInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    addExpense('CASH_JPY');
                }
            });
            
            // CARD_JPY æ¬„ä½çš„ Enter éµè™•ç†
            jpyCardInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    twdCardInput.focus();
                    event.preventDefault();
                }
            });
            twdCardInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    twdCardSelectJPY.focus();
                    event.preventDefault();
                }
            });
            twdCardSelectJPY.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    addExpense('CARD_JPY');
                }
            });
        }
        
        window.onload = init; 
    </script>
</body>
</html>
