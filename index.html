<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠé›™å¹£è¨˜å¸³</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        /* æ¨™é¡Œ */
        h1 {
            color: #d32f2f; /* é¡ä¼¼æ—¥æœ¬åœ‹æ——çš„ç´…è‰² */
            text-align: center;
            margin-bottom: 30px;
        }

        /* è¼¸å…¥å€å¡Šæ¨£å¼ */
        #input-area {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        #jpy-input, #twd-input {
            width: calc(100% - 22px);
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1.2em;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå¢åŠ æ•´é«”å¯¬åº¦ */
        }
        
        #twd-input {
            margin-top: 5px; /* å°å¹£è¼¸å…¥æ¡†èˆ‡æ—¥å¹£è¼¸å…¥æ¡†çš„é–“è· */
        }

        #jpy-input::placeholder, #twd-input::placeholder {
            color: #aaa;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            width: 100%;
            padding: 15px;
            background-color: #4CAF50; /* ç¶ è‰²ï¼Œè¡¨ç¤ºç¢ºèª */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }

        button:hover {
            background-color: #45a049;
        }

        /* ç¸½é‡‘é¡é¡¯ç¤ºå€ */
        #summary-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ffd400; /* é»ƒè‰² */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* ä¿®æ­£: ç¸½é¡å­—é«”å¤§å°ä¸€è‡´ */
        #total-jpy {
            font-size: 2.0em; 
            font-weight: bold;
            color: #d32f2f;
        }
        
        #total-twd {
            font-size: 2.0em; 
            font-weight: bold;
            color: #008080; /* å°å¹£ç”¨ä¸åŒçš„é¡è‰²å€åˆ† */
        }
        
        /* èª¿æ•´èªªæ˜æ–‡å­—çš„å­—é«”å¤§å° */
        #summary-area p {
            font-size: 1.1em; 
            margin: 5px 0 0 !important;
            color: #555;
        }

        /* æ­·å²è¨˜éŒ„å€ */
        #history-area {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* æ­·å²è¨˜éŒ„å€å¡Šæ¨™é¡Œå’ŒæŒ‰éˆ•çš„å®¹å™¨ */
        #history-header {
            display: flex; /* å•Ÿç”¨å½ˆæ€§ä½ˆå±€ */
            justify-content: space-between; /* æ¨™é¡Œé å·¦ï¼ŒæŒ‰éˆ•é å³ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 10px; /* å¢åŠ é–“è· */
        }
        
        /* å€å¡Šæ¨™é¡Œ */
        h2 {
            color: #333;
            border-bottom: none; 
            padding-bottom: 0;
            margin-bottom: 0;
            margin-top: 0;
        }
        
        /* æ¬¡ç´šæ¨™é¡Œ (æ—¥å¹£/å°å¹£) */
        h3 {
            margin-top: 25px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        /* æ—¥æœŸåˆ†çµ„æ¨™é¡Œæ¨£å¼ */
        .date-group {
            margin-top: 20px;
            margin-bottom: 10px;
            padding: 8px 10px;
            font-weight: bold;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* æ—¥å¹£æ—¥æœŸåˆ†çµ„ */
        #jpy-expense-list-container .date-group {
            background-color: #fbe4e4; /* æ·ºç´…è‰²èƒŒæ™¯ */
            color: #d32f2f; /* æ·±ç´…è‰²æ–‡å­— */
        }
        
        /* å°å¹£æ—¥æœŸåˆ†çµ„ */
        #twd-expense-list-container .date-group {
            background-color: #e0f7fa; /* æ·ºè—è‰²èƒŒæ™¯ */
            color: #008080; /* æ·±è—ç¶ è‰²æ–‡å­— */
        }

        .expense-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .expense-list li {
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
        }
        .expense-list li:last-child {
            border-bottom: none;
        }

        .item-description {
            flex-grow: 1;
            padding-right: 10px;
            color: #555;
        }

        /* é‡‘é¡é¡¯ç¤ºæ¨£å¼ */
        .item-amount {
            font-weight: bold;
            white-space: nowrap; /* é˜²æ­¢é‡‘é¡æ›è¡Œ */
        }
        
        /* æ—¥å¹£æ¸…å–®ä¸­çš„é‡‘é¡é¡è‰² */
        #jpy-expense-list-container .item-amount {
            color: #d32f2f;
        }
        
        /* å°å¹£æ¸…å–®ä¸­çš„é‡‘é¡é¡è‰² */
        #twd-expense-list-container .item-amount {
            color: #008080;
        }


        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1em;
            padding: 0 5px;
            margin-left: 10px;
            transition: color 0.2s;
            width: auto; /* è¦†è“‹ button çš„ 100% å¯¬åº¦ */
        }

        .delete-btn:hover {
            color: #d32f2f;
        }

        /* åŒ¯å‡ºæŒ‰éˆ•çš„æ¨£å¼ */
        #export-btn {
            width: auto; /* è¦†è“‹å…¨å¯¬è¨­å®š */
            padding: 8px 15px;
            background-color: #008CBA; /* è—è‰²ï¼Œè¡¨ç¤ºåŒ¯å‡º/è³‡è¨Š */
            font-size: 0.9em;
        }

        #export-btn:hover {
            background-color: #007bb5;
        }

        /* æ¸…é™¤æŒ‰éˆ• */
        #clear-btn {
            margin-top: 20px;
            background-color: #9e9e9e; /* ç°è‰² */
        }

        #clear-btn:hover {
            background-color: #757575;
        }
    </style>
</head>
<body>

    <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠé›™å¹£è¨˜å¸³ ğŸ’¸</h1>

    <div id="summary-area">
        <p>æ—¥å¹£ç¸½æ”¯å‡ºåˆè¨ˆ</p>
        <div id="total-jpy">Â¥ 0</div>
        <p>å°å¹£ç¸½æ”¯å‡ºåˆè¨ˆ</p>
        <div id="total-twd">NT$ 0</div>
    </div>

    <div id="input-area">
        <input type="text" id="jpy-input" placeholder="æ—¥å¹£é‡‘é¡: 1500 æ™šé¤" autofocus>
        <input type="text" id="twd-input" placeholder="å°å¹£é‡‘é¡: 3200 å”å‰è¨¶å¾·" style="margin-top: 10px;">
        <button onclick="addExpense()">+ è¨˜éŒ„é€™ç­†æ”¯å‡º</button>
    </div>

    <div id="history-area">
        <div id="history-header">
            <h2>ğŸ§¾ æ”¯å‡ºæ­·å²è¨˜éŒ„</h2>
            <button id="export-btn" onclick="exportToCsv()">åŒ¯å‡º Excel</button>
        </div>
        
        <h3 style="color: #d32f2f;">æ—¥å¹£æ”¯å‡º (Â¥)</h3>
        <div id="jpy-expense-list-container">
            </div>
        
        <h3 style="color: #008080;">å°å¹£æ”¯å‡º (NT$)</h3>
        <div id="twd-expense-list-container">
            </div>

        <button id="clear-btn" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„</button>
    </div>

    <script>
        const STORAGE_KEY = 'japan_trip_expenses_v2'; 
        const jpyInput = document.getElementById('jpy-input'); 
        const twdInput = document.getElementById('twd-input'); 
        
        // æ–°å¢å…©å€‹åˆ†é–‹çš„å®¹å™¨
        const jpyExpenseListContainer = document.getElementById('jpy-expense-list-container');
        const twdExpenseListContainer = document.getElementById('twd-expense-list-container');
        
        const totalJpyDisplay = document.getElementById('total-jpy'); 
        const totalTwdDisplay = document.getElementById('total-twd'); 
        let expenses = [];

        // --- å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ ---
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // --- å·¥å…·å‡½æ•¸ï¼šç²å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² ---
        function getTodayDateString() {
            return formatDate(new Date());
        }

        // --- æ ¸å¿ƒè§£æå‡½æ•¸ï¼šè§£æ [é‡‘é¡ å“é …] æ ¼å¼ ---
        function parseExpenseInput(inputText, currency) {
            const match = inputText.match(/^(\d+[\d\.]*)\s*(.*)/);
            let amount = 0;
            let description = '';

            if (match) {
                amount = parseFloat(match[1]);
                description = match[2] || `${currency}æ”¯å‡º`;
            }

            if (isNaN(amount) || amount < 0) {
                return { error: `è«‹è¼¸å…¥æœ‰æ•ˆçš„${currency}é‡‘é¡ï¼` };
            }
            
            return { amount, description: description.trim() };
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢æ”¯å‡º (å–®ç­†æäº¤) ---
        function addExpense() {
            const jpyInputText = jpyInput.value.trim();
            const twdInputText = twdInput.value.trim(); 

            // 1. æª¢æŸ¥æ˜¯å¦åŒæ™‚è¼¸å…¥å…©å€‹æ¬„ä½
            if (jpyInputText && twdInputText) {
                alert('è«‹åˆ†é–‹è¨˜éŒ„ï¼æ‚¨ä¸èƒ½åŒæ™‚åœ¨æ—¥å¹£å’Œå°å¹£æ¬„ä½è¼¸å…¥è³‡æ–™ã€‚è«‹æ¸…ç©ºå…¶ä¸­ä¸€å€‹æ¬„ä½å¾Œå†æäº¤ã€‚');
                return;
            }

            // 2. æª¢æŸ¥æ˜¯å¦éƒ½æ²’æœ‰è¼¸å…¥
            if (!jpyInputText && !twdInputText) {
                alert('è«‹è‡³å°‘è¼¸å…¥æ—¥å¹£æˆ–å°å¹£å…¶ä¸­ä¸€ç­†è¨˜éŒ„ï¼');
                return;
            }
            
            let amount = 0;
            let description = '';
            let isJpy = false;

            if (jpyInputText) {
                // è™•ç†æ—¥å¹£è¼¸å…¥
                const result = parseExpenseInput(jpyInputText, 'æ—¥å¹£');
                if (result.error) {
                    alert(result.error);
                    return;
                }
                amount = result.amount;
                description = result.description;
                isJpy = true;

            } else if (twdInputText) {
                // è™•ç†å°å¹£è¼¸å…¥
                const result = parseExpenseInput(twdInputText, 'å°å¹£');
                if (result.error) {
                    alert(result.error);
                    return;
                }
                amount = result.amount;
                description = result.description;
                isJpy = false;
            }

            // 3. å‰µå»ºæ–°çš„æ”¯å‡ºè¨˜éŒ„ (åªæœƒè¨˜éŒ„å…¶ä¸­ä¸€å€‹å¹£åˆ¥ï¼Œå¦ä¸€å€‹ç‚º 0)
            const newExpense = {
                id: Date.now(),
                jpy_amount: isJpy ? amount : 0,
                twd_amount: isJpy ? 0 : amount,
                description: description, 
                date: getTodayDateString()
            };

            expenses.unshift(newExpense);
            saveAndRefresh();

            jpyInput.value = '';
            twdInput.value = '';
            jpyInput.focus(); 
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆªé™¤å–®ç­†æ”¯å‡º ---
        function deleteExpense(id) {
            expenses = expenses.filter(expense => expense.id !== id);
            saveAndRefresh();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸…ç©ºæ‰€æœ‰æ•¸æ“š ---
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨˜å¸³è¨˜éŒ„å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                expenses = [];
                saveAndRefresh();
            }
        }
        
        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåŒ¯å‡ºæ•¸æ“šç‚º CSV æ ¼å¼ ---
        function exportToCsv() {
            if (expenses.length === 0) {
                alert('æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            // CSV æ¨™é ­
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF æ˜¯ BOMï¼Œç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
            csvContent += "æ—¥æœŸ,èªªæ˜,æ—¥å¹£é‡‘é¡(Â¥),å°å¹£é‡‘é¡(NT$)\n"; 

            // æ•¸æ“šè¡Œ
            expenses.forEach(expense => {
                // å°‡æ‰€æœ‰é€—è™Ÿæ›¿æ›ç‚ºåˆ†è™Ÿï¼Œé˜²æ­¢ CSV æ¬„ä½æ··äº‚
                const descriptionSafe = expense.description.replace(/,/g, ';'); 
                
                const jpy = expense.jpy_amount.toFixed(0); // æ—¥å¹£ä¸ä¿ç•™å°æ•¸
                const twd = expense.twd_amount.toFixed(0); // å°å¹£ä¸ä¿ç•™å°æ•¸
                
                csvContent += `${expense.date},${descriptionSafe},${jpy},${twd}\n`;
            });

            // å‰µå»ºé€£çµä¸¦ä¸‹è¼‰æ–‡ä»¶
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            
            // è¨­å®šä¸‹è¼‰æª”å
            const filename = `japan_budget_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.csv`;
            link.setAttribute("download", filename);
            
            // é»æ“Šé€£çµè§¸ç™¼ä¸‹è¼‰
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- æ•¸æ“šè™•ç†ï¼šå„²å­˜å’Œåˆ·æ–° ---
        function saveAndRefresh() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            renderExpenses();
            calculateTotal();
        }

        // --- ç•«é¢æ›´æ–°ï¼šè¨ˆç®—ç¸½é¡ (å·²ä¿®æ­£å°å¹£ç‚ºç„¡å°æ•¸é») ---
        function calculateTotal() {
            const totalJpy = expenses.reduce((sum, expense) => sum + expense.jpy_amount, 0);
            const totalTwd = expenses.reduce((sum, expense) => sum + expense.twd_amount, 0);

            // æ—¥å¹£ç¸½åˆè¨ˆ (ç¶­æŒç„¡å°æ•¸é»)
            totalJpyDisplay.textContent = 'Â¥ ' + totalJpy.toLocaleString('ja-JP', { maximumFractionDigits: 0 });
            
            // å°å¹£ç¸½åˆè¨ˆ (ä¿®æ­£ç‚ºç„¡å°æ•¸é»)
            totalTwdDisplay.textContent = 'NT$ ' + totalTwd.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        // --- ç•«é¢æ›´æ–°ï¼šæ¸²æŸ“åˆ—è¡¨ (åˆ†é–‹è™•ç† JPY å’Œ TWD) ---
        function renderExpenses() {
            // æ¸…ç©ºå…©å€‹å®¹å™¨
            jpyExpenseListContainer.innerHTML = '';
            twdExpenseListContainer.innerHTML = '';

            if (expenses.length === 0) {
                jpyExpenseListContainer.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰æ—¥å¹£è¨˜éŒ„ã€‚</p>';
                twdExpenseListContainer.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰å°å¹£è¨˜éŒ„ã€‚</p>';
                return;
            }

            // 1. éæ¿¾æ”¯å‡ºåˆ—è¡¨
            const jpyList = expenses.filter(e => e.jpy_amount > 0);
            const twdList = expenses.filter(e => e.twd_amount > 0);

            // 2. è¼”åŠ©å‡½æ•¸ï¼šæ¸²æŸ“å–®ä¸€å¹£åˆ¥çš„æ¸…å–®
            function renderList(container, list, isJPY) {
                if (list.length === 0) {
                    container.innerHTML = `<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰${isJPY ? 'æ—¥å¹£' : 'å°å¹£'}è¨˜éŒ„ã€‚</p>`;
                    return;
                }
                
                const currencySymbol = isJPY ? 'Â¥' : 'NT$';
                const currencyLocale = isJPY ? 'ja-JP' : 'zh-TW';
                // çµ±ä¸€è¨­ç½®ï¼šæ—¥å¹£ç„¡å°æ•¸ï¼Œå°å¹£ä¹Ÿç„¡å°æ•¸
                const fractionDigits = 0; 
                const amountKey = isJPY ? 'jpy_amount' : 'twd_amount';

                // a. æŒ‰æ—¥æœŸåˆ†çµ„
                const groupedExpenses = list.reduce((groups, expense) => {
                    const date = expense.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(expense);
                    return groups;
                }, {});

                // b. ç²å–æ’åºå¾Œçš„æ—¥æœŸ
                const sortedDates = Object.keys(groupedExpenses).sort().reverse();
                
                let htmlContent = '';

                sortedDates.forEach(date => {
                    const dailyExpenses = groupedExpenses[date];

                    // è¨ˆç®—ç•¶æ—¥ç¸½æ”¯å‡º
                    const dailyTotal = dailyExpenses.reduce((sum, expense) => sum + expense[amountKey], 0);
                    // ç¢ºä¿æ—¥ç¸½è¨ˆä¹Ÿç„¡å°æ•¸é»
                    const dailyTotalFormatted = dailyTotal.toLocaleString(currencyLocale, { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits });

                    // æ—¥æœŸåˆ†çµ„æ¨™é¡Œ
                    htmlContent += `
                        <div class="date-group">
                            <span>${date}</span> 
                            <span>åˆè¨ˆ: ${currencySymbol} ${dailyTotalFormatted}</span>
                        </div>
                        <ul class="expense-list">
                    `;

                    // æ¸…å–®é …ç›®
                    dailyExpenses.forEach(expense => {
                        const itemAmount = expense[amountKey];
                        // ç¢ºä¿å–®ç­†é‡‘é¡ä¹Ÿç„¡å°æ•¸é»
                        const itemAmountFormatted = itemAmount.toLocaleString(currencyLocale, { maximumFractionDigits: fractionDigits });
                        
                        htmlContent += `
                            <li>
                                <span class="item-description">${expense.description}</span>
                                <span class="item-amount">${currencySymbol} ${itemAmountFormatted}</span>
                                <button class="delete-btn" onclick="deleteExpense(${expense.id})">x</button>
                            </li>
                        `;
                    });

                    htmlContent += `</ul>`;
                });
                
                container.innerHTML = htmlContent;
            }

            // 3. å‘¼å«è¼”åŠ©å‡½æ•¸ï¼Œåˆ†åˆ¥æ¸²æŸ“ JPY å’Œ TWD
            renderList(jpyExpenseListContainer, jpyList, true);
            renderList(twdExpenseListContainer, twdList, false);
        }
        
        // --- åˆå§‹åŒ– ---
        function init() {
            const storedExpenses = localStorage.getItem(STORAGE_KEY);
            if (storedExpenses) {
                expenses = JSON.parse(storedExpenses);
            }
            renderExpenses();
            calculateTotal();
            
            // è¨­å®š Enter éµæäº¤
            jpyInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    addExpense();
                }
            });
            twdInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    addExpense();
                }
            });
        }
        
        window.onload = init; 
    </script>
</body>
</html>
